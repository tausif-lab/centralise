# PDF Stream Error Fix - ERR_STREAM_WRITE_AFTER_END\n\n## Error Description\n```\nError [ERR_STREAM_WRITE_AFTER_END]: write after end\n    at write_ (node:_http_outgoing:956:11)\n    at ServerResponse.write (node:_http_outgoing:905:15)\n    at PDFDocument.ondata (node:internal/streams/readable:1009:22)\n```\n\nThis error occurred when trying to generate PDF files. The response stream was being ended before the PDF document finished writing all its data.\n\n## Root Cause\nThe error happened because:\n1. The response stream was ended prematurely\n2. The try-catch error handler was attempting to write to the response after it had already been closed\n3. No proper error handling for stream events\n\n## Solution Implemented\n\n### 1. Added Stream Error Handlers\nAdded event listeners to both the PDF document and response streams:\n\n```javascript\n// Handle errors on both doc and res streams\ndoc.on('error', (err) => {\n  console.error('PDF Document Error:', err);\n  if (!res.headersSent) {\n    res.status(500).json({ message: 'Error generating PDF', error: err.message });\n  }\n  doc.destroy();\n});\n\nres.on('error', (err) => {\n  console.error('Response Stream Error:', err);\n  doc.destroy();\n});\n```\n\n### 2. Improved Catch Block Error Handling\nUpdated the catch block to check if response is writable:\n\n```javascript\ncatch (error) {\n  console.error('PDF Generation Error:', error);\n  \n  // Only send error response if response hasn't started\n  if (!res.writableEnded && !res.headersSent) {\n    res.status(500).json({ message: 'Error generating PDF', error: error.message });\n  }\n}\n```\n\n### 3. Fixed Activity Category References\nUpdated the PDF generation to properly reference activity categories:\n- Changed `organizedActivities.certificates` to `organizedActivities.workshops`\n- Split accomplishments into separate sections:\n  - Hackathons\n  - Sports\n  - Achievements\n\n## Changes Made\n\nFile Modified: `/Backend/controllers/portfolioController.js`\n\n**Key Changes:**\n1. Added error event handlers for both PDF document and response stream (lines 220-232)\n2. Added stream state checks before writing error responses (line 445)\n3. Fixed category references in PDF sections (lines 324, 362-532)\n4. Properly separated achievement categories for better PDF organization\n\n## How It Works Now\n\n### Before (Broken):\n```\nPDF Doc generates → Response ends → More data to write → CRASH\n```\n\n### After (Fixed):\n```\nError on Stream? → Destroy both gracefully → Log error\nResponse already sent? → Don't try to send again\nPDF writing done? → Response naturally closes\n```\n\n## Error Prevention Strategies\n\n1. **Stream Event Listeners**: Catch errors at the stream level before they crash the server\n2. **Response State Checks**: Check `writableEnded` and `headersSent` before writing\n3. **Proper Cleanup**: Destroy streams gracefully if errors occur\n4. **Logging**: Enhanced logging for debugging\n\n## Testing\n\n### To verify the fix works:\n1. Start the backend server\n2. Login as a user\n3. Navigate to Portfolio → Generate PDF\n4. PDF should generate and download without server crash\n5. Check server console for proper logging\n\n### Expected Console Output:\n```\nGenerating PDF for userId: [userId]\nUser found: [UserName]\nPortfolio found: Yes\nActivities found: [count]\nPDF generation completed\n```\n\n## Files Updated\n- `/Backend/controllers/portfolioController.js` - Fixed stream error handling\n\n## Dependencies Used\n- **pdfkit**: For PDF generation\n- **Node.js Stream API**: For handling data streams\n- **Express**: For HTTP response management\n\n## Notes\n- The fix prevents the server from crashing when PDF generation encounters errors\n- Proper error responses are sent to the client even if stream errors occur\n- All stream resources are properly cleaned up to prevent memory leaks\n- Added comprehensive error logging for debugging\n\n## Future Improvements\n- Add PDF generation queue for large portfolios\n- Implement caching for generated PDFs\n- Add retry logic for failed PDF generations\n- Monitor stream health metrics\n"